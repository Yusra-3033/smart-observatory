<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>منصة المرصد الذكي</title>

  <link rel="icon" href="/logo.png" type="image/png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Chart.js (Dashboard Pie) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700;900&display=swap');
    body { font-family: 'Noto Sans Arabic', sans-serif; background-color: #f0f7ff; }
    :root{
      --primary:#1e40af;
      --bg:#f0f7ff;
      --accent:#22c55e;
    }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
    .modal-active { display: flex !important; }
    .glass-card {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(30,64,175,0.10);
    }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
    .entity-link { transition: all 0.2s; border: 1px solid transparent; }
    .entity-link:hover { transform: translateY(-2px); border-color: var(--primary); background-color: var(--bg); }
    .status-badge { padding: 6px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 800; border: 1px solid transparent; cursor: default; }
    .priority-badge { padding: 4px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 800; }
    .tab-active {
      background-color: var(--primary) !important;
      color: white !important;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.10), 0 4px 6px -2px rgba(0,0,0,0.05) !important;
      font-weight: 900 !important;
    }
    input, select, textarea { font-size: 16px; }
    .icon-18 { font-size: 18px; }
    .icon-20 { font-size: 20px; }
    .icon-22 { font-size: 22px; }
    /* Sortable header UX */
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background: rgba(255,255,255,0.10); }
    /* Pie chart: smaller & centered */
    #analyticsView .glass-card{
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    /* Make the chart area take the remaining height */
    #analyticsView .chart-fill{
      flex: 1;
      display: flex;
      align-items: center;
    }
    #analyticsView .grid {
      gap: 24px; /* same spacing everywhere */
    }
    /* Donut + legend row */
    .donut-row {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    /* Donut fixed size */
    .donut-canvas {
      width: 240px;
      max-width: 55%;
    }
    /* Legend column */
    .donut-legend {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    /* Mobile fallback */
    @media (max-width: 1024px) {
      .donut-row {
        flex-direction: column;
      }
      .donut-canvas {
        width: 260px;
        margin: 0 auto;
      }
    }
    .pie-wrap{
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 6px 0 2px;
    }
    .pie-box{
      width: 260px;
      max-width: 90vw;
    }
    /* Highlight today in calendar */
    .today-cell{
      border: 2px solid rgba(30, 64, 175, 0.55) !important;
      background: rgba(30, 64, 175, 0.06) !important;
      box-shadow: inset 0 0 0 2px rgba(30, 64, 175, 0.10);
    }
    .today-pill{
      background: rgba(30, 64, 175, 0.10);
      color: #1e40af;
      padding: 2px 8px;
      border-radius: 9999px;
      font-weight: 900;
      font-size: 11px;
    }
    .pie-row{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:16px;
    }
    .pie-legend{
      width: 190px;
      max-width: 45%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .legend-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-bottom:1px solid rgba(30,64,175,0.08);
    }
    .event-chip{
      color:#fff;
      padding:6px 8px;
      border-radius:12px;
      margin-top:6px;
      font-weight:800;
      font-size:11px;
      line-height:1.1;
      box-shadow: 0 10px 18px rgba(2,6,23,.10);
      border: 1px solid rgba(255,255,255,.55);
    }
    .legend-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .legend-dot{ width:10px;height:10px;border-radius:9999px;flex:0 0 auto; }
    .legend-label{
      font-weight:800;font-size:13px;color:#334155;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width: 220px;
    }
    .legend-val{ font-weight:900;font-size:12px;color:#64748b;flex:0 0 auto; }
    #citiesDonut, #eventsPerMonthBar{
      max-height: 260px;
    } 
    /* Make the bar chart not feel too wide inside its 2-col card */
    .bar-wrap{
      width: 100%;
      max-width: 720px;   /* adjust: 640 / 700 / 760 */
      margin: 0 auto;     /* center inside the card */
    }
    /* ensure the canvas uses the wrapper width */
    .bar-wrap canvas{
      width: 100% !important;
    }
    /* KPI cards (Analytics top row) */
    .kpi-card{
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;     /* center horizontally */
      text-align:center;      /* center text */
      min-height: 160px;      /* taller boxes */
      padding-top: 28px;
      padding-bottom: 28px;
    }
    .kpi-label{
      color:#64748b;
      font-weight:800;
      font-size:13px;
    }
    .kpi-value{
      margin-top: 10px;
      font-weight:900;
      font-size: 44px;
      line-height: 1;
      color:#0f172a;
    }
    @media (max-width: 1024px){
      .pie-row{ flex-direction:column; }
      .pie-legend{ width:100%; max-width:100%; }
      .legend-label{ max-width: 100%; }
    }
    /* Donut + legend row */
    .donut-row {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    /* Donut fixed size */
    .donut-canvas {
      width: 200px;
      max-width: 50%;
      flex-shrink: 0;
    }
    /* Legend column */
    .donut-legend {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }
    /* Mobile fallback */
    @media (max-width: 1024px) {
      .donut-row {
        flex-direction: column;
      }
      .donut-canvas {
        width: 220px;
        margin: 0 auto;
      }
    }
  </style>
</head>

<body class="text-slate-900 min-h-screen">

  <!-- Header -->
  <header class="bg-white border-b sticky top-0 z-30 shadow-md border-blue-100">
    <div class="mx-auto w-full max-w-screen-2xl px-3 sm:px-4 lg:px-8 py-4">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">

        <div class="flex items-center gap-3">
          <div class="bg-blue-700 p-2.5 rounded-2xl text-white shadow-lg">
            <i class="fa-solid fa-calendar-check icon-22"></i>
          </div>
          <div>
            <h1 class="text-2xl font-black text-blue-900 tracking-tight">المرصد الذكي</h1>
            <p class="text-xs text-blue-600 font-medium">منصة إدارة الفعاليات والأحداث</p>
          </div>
        </div>

        <div class="w-full md:w-auto flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
          <div class="relative w-full sm:w-72 md:w-80">
            <i class="fa-solid fa-search absolute right-3 top-1/2 -translate-y-1/2 text-blue-400 icon-18"></i>
            <input
              type="text"
              id="searchInput"
              placeholder="ابحث باسم الحدث أو المالك..."
              class="w-full pr-10 pl-4 py-2.5 border-2 border-blue-50 rounded-2xl text-sm focus:border-blue-500 outline-none transition-all bg-white"
            />
          </div>

          <button id="addEventBtn" onclick="openModal()"
                  class="w-full sm:w-auto bg-blue-700 text-white px-6 py-2.5 rounded-2xl flex items-center justify-center gap-2 hover:bg-blue-800 shadow-lg active:scale-[0.99] transition-all duration-200">
            <i class="fa-solid fa-plus icon-18"></i>
            <span class="font-black">إضافة حدث</span>
          </button>
        </div>

      </div>
    </div>
  </header>

  <main class="mx-auto w-full max-w-screen-2xl px-3 sm:px-4 lg:px-8 py-4 md:py-8">
      
    <!-- Controls row -->
    <div class="flex flex-col lg:flex-row justify-between items-stretch lg:items-center mb-6 md:mb-8 gap-4">
      <div class="flex bg-white rounded-2xl p-1.5 border-2 border-blue-50 shadow-sm overflow-x-auto max-w-full" id="tabsContainer">
        <button onclick="switchView('analytics')" id="analyticsBtn"
                class="flex items-center gap-2 px-5 py-2 rounded-xl transition-all duration-200 text-blue-700 hover:bg-blue-50 font-extrabold whitespace-nowrap">
          <i class="fa-solid fa-chart-column icon-18"></i> <span>التحليلات</span>
        </button>
        <button onclick="switchView('table')" id="tableBtn"
                class="flex items-center gap-2 px-5 py-2 rounded-xl transition-all duration-200 font-extrabold text-blue-700 hover:bg-blue-50 whitespace-nowrap">
          <i class="fa-solid fa-table-list icon-18"></i> <span>الجدول التفاعلي</span>
        </button>
        <button onclick="switchView('calendar')" id="calendarBtn"
                class="flex items-center gap-2 px-5 py-2 rounded-xl transition-all duration-200 text-blue-700 hover:bg-blue-50 font-extrabold whitespace-nowrap">
          <i class="fa-solid fa-calendar-day icon-18"></i> <span>التقويم</span>
        </button>
        <button onclick="switchView('directory')" id="directoryBtn"
                class="flex items-center gap-2 px-5 py-2 rounded-xl transition-all duration-200 text-blue-700 hover:bg-blue-50 font-extrabold whitespace-nowrap">
          <i class="fa-solid fa-sitemap icon-18"></i> <span>دليل الجهات والمجموعات</span>
        </button>
      </div>

      <!-- Optional mobile sort controls for table view -->
      <div id="tableSortControls" class="flex md:hidden items-center gap-3 bg-white px-4 py-3 rounded-2xl border-2 border-blue-50 shadow-sm">
        <div class="text-sm font-black text-blue-900 whitespace-nowrap">
          <i class="fa-solid fa-arrow-up-wide-short icon-18 text-blue-700"></i> فرز
        </div>
        <select id="mobileSortSelect" class="w-full border p-2.5 rounded-2xl outline-none">
          <option value="start:desc">التاريخ (الأحدث)</option>
          <option value="start:asc">التاريخ (الأقدم)</option>
          <option value="name:asc">الحدث (أ-ي)</option>
          <option value="name:desc">الحدث (ي-أ)</option>
          <option value="owner:asc">المالك (أ-ي)</option>
          <option value="owner:desc">المالك (ي-أ)</option>
          <option value="priority:desc">الأولوية (عالي أولاً)</option>
          <option value="priority:asc">الأولوية (منخفض أولاً)</option>
          <option value="counter:asc">العدّاد (الأقرب أولاً)</option>
          <option value="counter:desc">العدّاد (الأبعد أولاً)</option>
        </select>
      </div>

      <div id="calendarControls" class="hidden items-center justify-between gap-4 bg-white px-4 py-2.5 rounded-2xl border-2 border-blue-50 shadow-sm">
        <button onclick="changeMonth(-1)" class="w-9 h-9 rounded-full hover:bg-blue-50 text-blue-700 transition-all duration-200">
          <i class="fa-solid fa-chevron-right icon-18"></i>
        </button>
        <span id="currentMonthLabel" class="text-base md:text-lg font-black text-blue-900"></span>
        <button onclick="changeMonth(1)" class="w-9 h-9 rounded-full hover:bg-blue-50 text-blue-700 transition-all duration-200">
          <i class="fa-solid fa-chevron-left icon-18"></i>
        </button>
      </div>

      <div id="directoryControls" class="hidden">
        <button onclick="openEntityModal()"
                class="w-full lg:w-auto bg-blue-600 text-white px-5 py-2.5 rounded-2xl flex items-center justify-center gap-2 hover:bg-blue-700 shadow-lg hover:scale-[1.02] transition-all duration-200 font-black">
          <i class="fa-solid fa-plus-circle icon-18"></i> إضافة جهة/رابط
        </button>
      </div>
    </div>

    <!-- Views -->
    <div id="mainContainer">

      <!-- Analytics view  -->
      <div id="analyticsView" class="hidden space-y-6">

        <!-- KPI Row (Top of Analytics) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Total -->
          <div class="kpi-card glass-card rounded-3xl p-6 shadow-lg">
            <div class="kpi-label">إجمالي الأحداث</div>
            <div id="kpiTotal" class="kpi-value">0</div>
          </div>

          <!-- Completed -->
          <div class="kpi-card glass-card rounded-3xl p-6 shadow-lg">
            <div class="kpi-label">المكتملة</div>
            <div id="kpiDone" class="kpi-value">0</div>
          </div>

          <!-- Uncompleted -->
          <div class="kpi-card glass-card rounded-3xl p-6 shadow-lg">
            <div class="kpi-label">غير المكتملة</div>
            <div id="kpiOpen" class="kpi-value">0</div>
          </div>

          <!-- Completion Rate -->
          <div class="kpi-card glass-card rounded-3xl p-6 shadow-lg">
            <div class="kpi-label">نسبة الإنجاز</div>
            <div id="kpiCompletion" class="kpi-value">0%</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div class="glass-card rounded-3xl p-6 shadow-lg lg:col-span-1">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-black text-blue-900 flex items-center gap-2">
                  <i class="fa-solid fa-chart-pie text-blue-700 icon-18"></i>
                  توزيع حسب الموقع
                </h3>
              </div>
            
              <!-- NEW: donut + legend side-by-side -->
              <div class="chart-fill">
                <div class="donut-row">
                  <div class="donut-canvas">
                    <canvas id="citiesDonut" height="220"></canvas>
                  </div>
                  <div id="citiesLegend" class="donut-legend"></div>
                </div>
              </div>              
          </div>

          <div class="glass-card rounded-3xl p-6 shadow-lg lg:col-span-2">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-black text-blue-900 flex items-center gap-2">
                <i class="fa-solid fa-chart-column text-blue-700 icon-18"></i>
                عدد الأحداث لكل شهر
              </h3>
            </div>
            <div class="chart-fill w-full">
              <div class="bar-wrap">
                <canvas id="eventsPerMonthBar" height="140"></canvas>
              </div>
            </div>           
          </div>

        </div>
      </div>

      <!-- Table View -->
      <div id="tableView" class="glass-card rounded-3xl shadow-lg overflow-hidden border-0">

        <!-- Mobile cards -->
        <div id="eventsCards" class="md:hidden p-4 sm:p-6 space-y-3"></div>

        <!-- Desktop table -->
        <div class="hidden md:block overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-blue-700 text-white">
              <tr>
                <th class="px-6 py-5 text-right font-black sortable" data-key="name">
                  <div class="flex items-center justify-between gap-2">
                    <span>الحدث</span>
                    <span class="sort-indicator opacity-90" data-key="name"></span>
                  </div>
                </th>
                <th class="px-4 py-5 text-right font-black sortable w-[140px]" data-key="priority">
                  <div class="flex items-center justify-between gap-2">
                    <span>الأولوية</span>
                    <span class="sort-indicator opacity-90" data-key="priority"></span>
                  </div>
                </th>
                <th class="px-4 py-5 text-right font-black sortable" data-key="owner">
                  <div class="flex items-center justify-between gap-2">
                    <span>المالك</span>
                    <span class="sort-indicator opacity-90" data-key="owner"></span>
                  </div>
                </th>
                <th class="px-4 py-5 text-right font-black sortable" data-key="assignees">
                  <div class="flex items-center justify-between gap-2">
                    <span>ضمن اختصاص</span>
                    <span class="sort-indicator opacity-90" data-key="assignees"></span>
                  </div>
                </th>
                <th class="px-4 py-5 text-right font-black sortable" data-key="location">
                  <div class="flex items-center justify-between gap-2">
                    <span>الموقع</span>
                    <span class="sort-indicator opacity-90" data-key="location"></span>
                  </div>
                </th>
                <th class="px-4 py-5 text-right font-black sortable w-[130px]" data-key="start">
                  <div class="flex items-center justify-between gap-2">
                    <span>تاريخ البدء</span>
                    <span class="sort-indicator opacity-90" data-key="start"></span>
                  </div>
                </th>

                <!-- REMOVED: end date column header -->

                <th class="px-4 py-5 text-right font-black sortable w-[170px]" data-key="counter">
                  <div class="flex items-center justify-between gap-2">
                    <span>العدّاد</span>
                    <span class="sort-indicator opacity-90" data-key="counter"></span>
                  </div>
                </th>
                <th class="px-6 py-5 text-center font-black">إجراءات</th>
              </tr>
            </thead>
            <tbody id="eventsTableBody" class="divide-y divide-blue-50"></tbody>
          </table>
        </div>
      </div>

      <!-- Calendar View -->
      <div id="calendarView" class="hidden glass-card rounded-3xl shadow-lg overflow-hidden border-0">
        <div id="calendarAgenda" class="md:hidden p-4 sm:p-6 space-y-3 bg-white"></div>

        <div class="hidden md:block">
          <div class="calendar-grid bg-blue-50/50 text-center text-xs font-black text-blue-800">
            <div class="py-4">الأحد</div><div class="py-4">الاثنين</div><div class="py-4">الثلاثاء</div><div class="py-4">الأربعاء</div><div class="py-4">الخميس</div><div class="py-4 text-red-500">الجمعة</div><div class="py-4">السبت</div>
          </div>
          <div id="calendarGrid" class="calendar-grid bg-white"></div>
        </div>
      </div>

      <!-- Directory View -->
      <div id="directoryView" class="hidden space-y-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">

          <div class="glass-card rounded-3xl p-8 hover:scale-[1.01] transition-all duration-200 shadow-lg">
            <h3 class="text-lg font-black text-blue-900 mb-5 flex items-center gap-2 border-b pb-4">
              <i class="fa-solid fa-building-shield text-blue-700 icon-18"></i> الجهات الإشرافية
            </h3>
            <div id="supervisoryGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
          </div>

          <div class="glass-card rounded-3xl p-8 hover:scale-[1.01] transition-all duration-200 shadow-lg">
            <h3 class="text-lg font-black text-blue-900 mb-5 flex items-center gap-2 border-b pb-4">
              <i class="fa-solid fa-hand-holding-heart text-blue-700 icon-18"></i> الجهات الداعمة
            </h3>
            <div id="supportingGrid" class="grid grid-cols-1 gap-3"></div>
          </div>

          <div class="glass-card rounded-3xl p-8 lg:col-span-2 hover:scale-[1.01] transition-all duration-200 shadow-lg">
            <h3 class="text-lg font-black text-blue-900 mb-5 flex items-center gap-2 border-b pb-4">
              <i class="fa-solid fa-users-gear text-blue-700 icon-18"></i> كيانات القطاع والشركاء الفاعلين
            </h3>
            <div id="partnersGrid" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
          </div>

          <div class="glass-card rounded-3xl p-8 bg-gradient-to-br from-green-50 to-white border-green-100 lg:col-span-2 shadow-lg hover:scale-[1.01] transition-all duration-200">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-5 border-b border-green-100 pb-4">
              <h3 class="text-lg font-black text-green-800 flex items-center gap-2">
                <i class="fa-brands fa-whatsapp icon-22 text-green-600"></i> مجموعات الواتساب
              </h3>
              <button onclick="openWhatsappModal()"
                      class="text-sm bg-green-600 text-white px-4 py-2 rounded-2xl font-black hover:bg-green-700 shadow-lg hover:scale-[1.02] transition-all duration-200 w-full sm:w-auto">
                <i class="fa-solid fa-plus ml-1 icon-18"></i> إضافة مجموعة
              </button>
            </div>
            <div id="whatsappGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          </div>

        </div>
      </div>

    </div>
  </main>

  <!-- Modals -->
  <div id="eventModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle"
       class="fixed inset-0 z-50 hidden items-center justify-center bg-blue-900/40 backdrop-blur-sm p-3 sm:p-4">
    <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl p-6 sm:p-10 max-h-[90vh] overflow-y-auto">
      <div class="flex items-start justify-between gap-4 mb-6">
        <h2 id="modalTitle" class="text-xl sm:text-2xl font-black text-blue-900">إضافة حدث جديد</h2>
        <button type="button" onclick="closeModal()" class="w-10 h-10 rounded-2xl hover:bg-blue-50 text-blue-800 transition-all duration-200">
          <i class="fa-solid fa-xmark icon-20"></i>
        </button>
      </div>

      <form id="eventForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="eventId">

        <div class="md:col-span-2">
          <label class="text-sm font-black block mb-1">اسم الحدث</label>
          <input id="fName" required class="w-full border p-3 rounded-2xl outline-none focus:border-blue-500">
        </div>

        <div>
          <label class="text-sm font-black block mb-1">الأولوية</label>
          <select id="fPriority" class="w-full border p-3 rounded-2xl outline-none">
            <option value="عالي الأولوية">عالي الأولوية</option>
            <option value="متوسط الأولوية">متوسط الأولوية</option>
            <option value="منخفض الأولوية">منخفض الأولوية</option>
          </select>
        </div>

        <div>
          <label class="text-sm font-black block mb-1">المالك</label>
          <input id="fOwner" class="w-full border p-3 rounded-2xl outline-none">
        </div>

        <div>
          <label class="text-sm font-black block mb-1">ضمن اختصاص (1)</label>
          <input id="fAssignee1" placeholder="اسم الشخص المسؤول" class="w-full border p-3 rounded-2xl outline-none">
        </div>

        <div>
          <label class="text-sm font-black block mb-1">ضمن اختصاص (2) (اختياري)</label>
          <input id="fAssignee2" placeholder="اسم شخص إضافي (اختياري)" class="w-full border p-3 rounded-2xl outline-none">
        </div>

        <div>
          <label class="text-sm font-black block mb-1">الموقع</label>
          <input id="fLoc" class="w-full border p-3 rounded-2xl outline-none">
        </div>

        <div>
          <label class="text-sm font-black block mb-1">تاريخ البدء</label>
          <input type="date" id="fStart" required class="w-full border p-3 rounded-2xl outline-none">
        </div>

        <div>
          <label class="text-sm font-black block mb-1">تاريخ الانتهاء</label>
          <input type="date" id="fEnd" required class="w-full border p-3 rounded-2xl outline-none">
        </div>

        <div class="md:col-span-2">
          <label class="text-sm font-black block mb-1">رابط الفعالية</label>
          <input id="fLink" dir="ltr" class="w-full border p-3 rounded-2xl outline-none">
        </div>

        <div class="flex flex-col sm:flex-row justify-end gap-2 mt-4 md:col-span-2">
          <button type="button" onclick="closeModal()" class="px-6 py-2 rounded-2xl hover:bg-slate-50 font-black transition-all duration-200">إلغاء</button>
          <button type="submit" class="bg-blue-700 text-white px-8 py-2 rounded-2xl font-black hover:bg-blue-800 shadow-lg hover:scale-[1.02] transition-all duration-200">حفظ</button>
        </div>
      </form>
    </div>
  </div>

  <div id="entityModal" role="dialog" aria-modal="true" aria-labelledby="entityModalTitle"
       class="fixed inset-0 z-50 hidden items-center justify-center bg-blue-900/40 backdrop-blur-sm p-3 sm:p-4">
    <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl p-6 sm:p-10">
      <div class="flex items-start justify-between gap-4 mb-6">
        <h2 id="entityModalTitle" class="text-lg sm:text-xl font-black text-blue-900">إضافة جهة جديدة</h2>
        <button type="button" onclick="closeEntityModal()" class="w-10 h-10 rounded-2xl hover:bg-blue-50 text-blue-800 transition-all duration-200">
          <i class="fa-solid fa-xmark icon-20"></i>
        </button>
      </div>

      <form id="entityForm" class="space-y-4">
        <input type="hidden" id="entId">
        <input id="entName" placeholder="اسم الجهة" required class="w-full border p-3 rounded-2xl outline-none focus:border-blue-500">
        <input id="entUrl" placeholder="رابط الموقع الرسمي" required dir="ltr" class="w-full border p-3 rounded-2xl outline-none focus:border-blue-500">
        <select id="entCat" class="w-full border p-3 rounded-2xl outline-none">
          <option value="supervisory">جهة إشرافية</option>
          <option value="supporting">جهة داعمة</option>
          <option value="partners">شريك فاعل</option>
        </select>

        <div class="flex flex-col sm:flex-row justify-end gap-2 pt-2">
          <button type="button" onclick="closeEntityModal()" class="px-4 py-2 rounded-2xl hover:bg-slate-50 font-black transition-all duration-200">إلغاء</button>
          <button type="submit" class="bg-blue-600 text-white px-8 py-2 rounded-2xl font-black hover:bg-blue-700 shadow-lg hover:scale-[1.02] transition-all duration-200">حفظ</button>
        </div>
      </form>
    </div>
  </div>

  <div id="whatsappModal" role="dialog" aria-modal="true" aria-labelledby="waModalTitle"
       class="fixed inset-0 z-50 hidden items-center justify-center bg-blue-900/40 backdrop-blur-sm p-3 sm:p-4">
    <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl p-6 sm:p-10">
      <div class="flex items-start justify-between gap-4 mb-6">
        <h2 id="waModalTitle" class="text-lg sm:text-xl font-black text-green-800">إدارة المجموعة</h2>
        <button type="button" onclick="closeWhatsappModal()" class="w-10 h-10 rounded-2xl hover:bg-green-50 text-green-800 transition-all duration-200">
          <i class="fa-solid fa-xmark icon-20"></i>
        </button>
      </div>

      <form id="waForm" class="space-y-4">
        <input type="hidden" id="waId">
        <input id="waName" placeholder="اسم المجموعة" required class="w-full border p-3 rounded-2xl outline-none">
        <input id="waUrl" placeholder="رابط الواتساب" required dir="ltr" class="w-full border p-3 rounded-2xl outline-none">

        <div class="flex flex-col sm:flex-row justify-end gap-2 pt-2">
          <button type="button" onclick="closeWhatsappModal()" class="px-4 py-2 rounded-2xl hover:bg-slate-50 font-black transition-all duration-200">إلغاء</button>
          <button type="submit" class="bg-green-600 text-white px-8 py-2 rounded-2xl font-black hover:bg-green-700 shadow-lg hover:scale-[1.02] transition-all duration-200">حفظ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://hfwdocyrhiwspitmpvgg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhmd2RvY3lyaGl3c3BpdG1wdmdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMjAxNTcsImV4cCI6MjA4Mzc5NjE1N30.or59DKhlc7UcY4EQh-TOcCc3lNILgMvU0KpR-lsCL5g";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let events = [];
    let entities = [];
    let whatsappGroups = [];
    let currentView = 'table';
    let viewDate = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

    // Sorting state
    let sortState = { key: 'start', dir: 'desc' }; // default: newest first

    // Dashboard chart instance
    let citiesDonutChart = null;
    let eventsPerMonthChart = null;

    function safeLower(v) { return (v || '').toString().toLowerCase(); }

    function getGoogleCalendarLink(ev) {
      const start = (ev.start || '').replace(/-/g, '');
      const endDate = new Date(ev.end || ev.start);
      endDate.setDate(endDate.getDate() + 1);
      const end = `${endDate.getFullYear()}${String(endDate.getMonth()+1).padStart(2,'0')}${String(endDate.getDate()).padStart(2,'0')}`;
      return `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(ev.name || '')}&dates=${start}/${end}&details=${encodeURIComponent(ev.link || '')}&location=${encodeURIComponent(ev.location || 'الرياض')}`;
    }

    function getPriorityClass(p) {
      if ((p || '').includes('عالي')) return 'bg-red-100 text-red-700 border-red-200';
      if ((p || '').includes('متوسط')) return 'bg-orange-100 text-orange-700 border-orange-200';
      return 'bg-green-100 text-green-700 border-green-200';
    }

    function priorityRank(p) {
      if ((p || '').includes('عالي')) return 3;
      if ((p || '').includes('متوسط')) return 2;
      return 1;
    }

    function getStatusClassByState(ev) {
      const st = getCounterState(ev);
      if (st.type === 'done') return 'bg-green-600';
      if (st.type === 'running') return 'bg-amber-500';
      if (st.type === 'ended') return 'bg-green-600';
      if (st.type === 'upcoming') return 'bg-blue-600';
      return 'bg-slate-400';
    }

    function formatAssignees(ev) {
      const a1 = (ev.assignee1 || '').trim();
      const a2 = (ev.assignee2 || '').trim();
      if (a1 && a2) return `${a1}، ${a2}`;
      return a1 || a2 || '-';
    }

    function normalizeEventRow(row) {
      return {
        id: row.id,
        name: row.name || '',
        priority: row.priority || 'متوسط الأولوية',
        owner: row.owner || '',
        assignee1: row.assignee1 || '',
        assignee2: row.assignee2 || '',
        location: row.location || '',
        status: (row.status || 'لم تبدأ').trim(),
        start: row.start_date || '',
        end: row.end_date || row.start_date || '',
        link: row.link || ''
      };
    }

    function normalizeEntityRow(row) {
      return { id: row.id, name: row.name || '', url: row.url || '', category: row.category || 'supervisory' };
    }

    function normalizeWhatsappRow(row) {
      return { id: row.id, name: row.name || '', url: row.url || '' };
    }

    async function loadData() {
      const { data: eData, error: eErr } = await supabaseClient.from('events').select('*');
      if (eErr) console.error('Events Load Error:', eErr);
      events = (eData || []).map(normalizeEventRow);

      const { data: enData, error: enErr } = await supabaseClient.from('entities').select('*').order('id', { ascending: true });
      if (enErr) console.error('Entities Load Error:', enErr);
      entities = (enData || []).map(normalizeEntityRow);

      const { data: wData, error: wErr } = await supabaseClient.from('whatsapp_groups').select('*').order('id', { ascending: true });
      if (wErr) console.error('WhatsApp Load Error:', wErr);
      whatsappGroups = (wData || []).map(normalizeWhatsappRow);

      render();
    }

    // -------------------- Counter (start/end based) --------------------
    function parseDateYMD(dateStr) {
      if (!dateStr) return null;
      const [y, m, d] = dateStr.split('-').map(Number);
      if (!y || !m || !d) return null;
      return new Date(y, m - 1, d);
    }

    function startOfToday() {
      const n = new Date();
      return new Date(n.getFullYear(), n.getMonth(), n.getDate());
    }

    function dayDiff(fromDate, toDate) {
      const ms = toDate - fromDate;
      return Math.round(ms / (1000 * 60 * 60 * 24));
    }

    function getCounterState(ev) {
      if (ev.status === 'مكتملة') return { type: 'done', daysToStart: null };

      const today = startOfToday();
      const s = parseDateYMD(ev.start);
      const e = parseDateYMD(ev.end || ev.start);

      if (!s || !e) return { type: 'unknown', daysToStart: null };

      if (today > e) return { type: 'ended', daysToStart: dayDiff(today, s) };
      if (today >= s && today <= e) return { type: 'running', daysToStart: 0 };
      return { type: 'upcoming', daysToStart: dayDiff(today, s) };
    }

    function getCountdownBadge(ev) {
      const st = getCounterState(ev);

      // مكتملة → أخضر
      if (st.type === 'done') {
        return `<span class="status-badge bg-green-600 text-white">مكتملة</span>`;
      }
      // قيد التنفيذ → أصفر / برتقالي
      if (st.type === 'running') {
        return `<span class="status-badge bg-amber-500 text-white">قيد التنفيذ</span>`;
      }
      // انتهى → أخضر
      if (st.type === 'ended') {
        return `<span class="status-badge bg-green-600 text-white">انتهى</span>`;
      }
      // متبقي X يوم → أزرق
      if (st.type === 'upcoming') {
        return `<span class="status-badge bg-blue-600 text-white">متبقي ${st.daysToStart} يوم</span>`;
      }
      return `<span class="status-badge bg-slate-200 text-slate-700">غير محدد</span>`;
    }

    function counterSortValue(ev) {
      const st = getCounterState(ev);
      if (st.type === 'running') return -100000;
      if (st.type === 'upcoming') return st.daysToStart ?? 99999;
      if (st.type === 'ended') return 100000 + Math.abs(st.daysToStart ?? 0);
      if (st.type === 'done') return 200000;
      return 300000;
    }
    // ------------------------------------------------------------------

    // ---------- Dashboard ----------
    function getCityLabel(ev) {
      const loc = (ev.location || '').trim();
      return loc ? loc : 'غير محدد';
    }
    function isEndedByDate(ev){
      const today = new Date();
      const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const e = parseDateYMD(ev.end || ev.start);
      return e && t > e;
    }
    function updateDashboard() {
      const total = events.length;
      const done = events.filter(e => (e.status || '').trim() === 'مكتملة' || isEndedByDate(e)).length;
      const open = total - done;

      const completion = total ? Math.round((done / total) * 100) : 0;

      const totalEl = document.getElementById('kpiTotal');
      const doneEl = document.getElementById('kpiDone');
      const openEl = document.getElementById('kpiOpen');
      const completionEl = document.getElementById('kpiCompletion');

      if (totalEl) totalEl.textContent = String(total);
      if (doneEl) doneEl.textContent = String(done);
      if (openEl) openEl.textContent = String(open);
      if (completionEl) completionEl.textContent = `${completion}%`;
    }

    // -----------------------------------

    // ---------- Sorting helpers ----------
    function compareValues(a, b) { return a < b ? -1 : a > b ? 1 : 0; }

    function getSortValue(ev, key) {
      switch(key) {
        case 'name': return (ev.name || '').toString().trim();
        case 'owner': return (ev.owner || '').toString().trim();
        case 'location': return (ev.location || '').toString().trim();
        case 'start': return (ev.start || '').toString().trim();
        case 'priority': return priorityRank(ev.priority);
        case 'assignees': return formatAssignees(ev);
        case 'counter': return counterSortValue(ev);
        default: return (ev[key] || '').toString().trim();
      }
    }

    function getSortedEvents(list) {
      const { key, dir } = sortState;
      const sign = dir === 'asc' ? 1 : -1;

      return [...list].sort((e1, e2) => {
        const v1 = getSortValue(e1, key);
        const v2 = getSortValue(e2, key);

        if (typeof v1 === 'number' && typeof v2 === 'number') {
          if (v1 !== v2) return (v1 - v2) * sign;
        } else {
          const c = compareValues(String(v1).toLocaleLowerCase(), String(v2).toLocaleLowerCase());
          if (c !== 0) return c * sign;
        }

        const t = compareValues((e1.start || ''), (e2.start || '')) * -1;
        if (t !== 0) return t;
        return compareValues((e1.name || ''), (e2.name || ''));
      });
    }

    function setSort(key) {
      if (key === 'end') return; // just in case
      if (sortState.key === key) {
        sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.key = key;
        sortState.dir = (key === 'start' || key === 'priority') ? 'desc' : 'asc';
        if (key === 'counter') sortState.dir = 'asc';
      }
      updateSortIndicators();
      renderTable();
      renderCards();
      applySearchFilter();

      const ms = document.getElementById('mobileSortSelect');
      if (ms) ms.value = `${sortState.key}:${sortState.dir}`;
    }

    function updateSortIndicators() {
      document.querySelectorAll('.sort-indicator').forEach(el => el.textContent = '');
      const indicator = document.querySelector(`.sort-indicator[data-key="${sortState.key}"]`);
      if (!indicator) return;
      indicator.innerHTML = sortState.dir === 'asc'
        ? '<i class="fa-solid fa-arrow-up icon-18"></i>'
        : '<i class="fa-solid fa-arrow-down icon-18"></i>';
    }
    // -----------------------------------

    function renderTable() {
      const tbody = document.getElementById('eventsTableBody');
      if (!tbody) return;

      const sorted = getSortedEvents(events);

      tbody.innerHTML = sorted.map(ev => `
        <tr class="hover:bg-blue-50/50 transition-all duration-200 event-row"
            data-name="${safeLower(ev.name)}"
            data-owner="${safeLower(ev.owner)}">
          <td class="px-6 py-5">
            <div class="font-black text-blue-900">${ev.name}</div>
            ${ev.link ? `<a href="${ev.link}" target="_blank" class="text-[11px] text-blue-600 hover:underline">فتح الرابط <i class="fa-solid fa-arrow-up-right-from-square icon-18"></i></a>` : ''}
          </td>

          <td class="px-4 py-5">
            <span class="priority-badge border inline-flex items-center justify-center whitespace-nowrap leading-none
                         px-3 py-1 rounded-xl text-[12px] font-extrabold
                         ${getPriorityClass(ev.priority)}">
              ${ev.priority}
            </span>
          </td>

          <td class="px-4 py-5 font-semibold">${ev.owner || '-'}</td>
          <td class="px-4 py-5 font-semibold text-blue-700">${formatAssignees(ev)}</td>
          <td class="px-4 py-5 text-slate-600">${ev.location || 'غير محدد'}</td>
          <td class="px-4 py-5 font-mono text-xs whitespace-nowrap">${ev.start || '-'}</td>

          <!-- REMOVED: end date cell -->

          <td class="px-4 py-5">
            ${getCountdownBadge(ev)}
          </td>

          <td class="px-6 py-5 text-center">
            <div class="flex gap-4 justify-center">
              <a href="${getGoogleCalendarLink(ev)}" target="_blank" title="إضافة للتقويم" class="text-emerald-600 hover:scale-110 transition-all duration-200">
                <i class="fa-solid fa-calendar-plus icon-20"></i>
              </a>

              <button onclick="editEvent('${ev.id}')" class="text-blue-600 hover:scale-110 transition-all duration-200" title="تعديل">
                <i class="fa-solid fa-pen-to-square icon-20"></i>
              </button>

              <button onclick="deleteEvent('${ev.id}')" class="text-red-500 hover:scale-110 transition-all duration-200" title="حذف">
                <i class="fa-solid fa-trash-can icon-20"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function renderCards() {
      const wrap = document.getElementById('eventsCards');
      if (!wrap) return;

      const sorted = getSortedEvents(events);

      wrap.innerHTML = sorted.map(ev => `
        <div class="bg-white rounded-3xl border border-blue-50 shadow-lg p-5 sm:p-6 space-y-3 event-card hover:scale-[1.01] transition-all duration-200"
             data-name="${safeLower(ev.name)}"
             data-owner="${safeLower(ev.owner)}">

          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-black text-blue-900 truncate">${ev.name}</div>
              <div class="text-xs text-slate-500">${ev.start || '-'} • ${ev.location || 'غير محدد'}</div>
            </div>
            <span class="priority-badge border inline-flex items-center justify-center whitespace-nowrap leading-none
                         px-3 py-1 rounded-xl text-[12px] font-extrabold
                         ${getPriorityClass(ev.priority)}">
              ${ev.priority}
            </span>
          </div>

          <div class="text-sm space-y-1">
            <div class="flex items-center justify-between gap-2">
              <span class="text-slate-500 font-bold">المالك</span>
              <span class="font-extrabold">${ev.owner || '-'}</span>
            </div>
            <div class="flex items-center justify-between gap-2">
              <span class="text-slate-500 font-bold">ضمن اختصاص</span>
              <span class="font-extrabold text-blue-700">${formatAssignees(ev)}</span>
            </div>
          </div>

          <div class="flex items-center justify-between gap-3 pt-1">
            ${getCountdownBadge(ev)}

            <div class="flex gap-4">
              <a href="${getGoogleCalendarLink(ev)}" target="_blank" title="إضافة للتقويم" class="text-emerald-600 hover:scale-110 transition-all duration-200">
                <i class="fa-solid fa-calendar-plus icon-20"></i>
              </a>
              <button onclick="editEvent('${ev.id}')" class="text-blue-600 hover:scale-110 transition-all duration-200" title="تعديل">
                <i class="fa-solid fa-pen-to-square icon-20"></i>
              </button>
              <button onclick="deleteEvent('${ev.id}')" class="text-red-500 hover:scale-110 transition-all duration-200" title="حذف">
                <i class="fa-solid fa-trash-can icon-20"></i>
              </button>
            </div>
          </div>

          ${ev.link ? `<a href="${ev.link}" target="_blank" class="text-xs text-blue-700 underline break-all">رابط الفعالية</a>` : ''}
        </div>
      `).join('');
    }

    function renderCalendarAgenda(month, year) {
      const el = document.getElementById('calendarAgenda');
      if (!el) return;

      const monthStr = String(month + 1).padStart(2,'0');
      const inMonth = events
        .filter(e => (e.start || '').startsWith(`${year}-${monthStr}-`))
        .sort((a,b) => (a.start||'').localeCompare(b.start||''));

      if (!inMonth.length) {
        el.innerHTML = `<div class="text-sm text-slate-600 bg-blue-50 rounded-3xl p-5 sm:p-6 font-bold shadow-sm">لا توجد فعاليات هذا الشهر.</div>`;
        return;
      }

      const groups = {};
      inMonth.forEach(e => { (groups[e.start] ||= []).push(e); });

      el.innerHTML = Object.keys(groups).sort().map(date => `
        <div class="bg-white border border-blue-50 rounded-3xl p-5 sm:p-6 shadow-lg hover:scale-[1.01] transition-all duration-200">
          <div class="font-black text-blue-900 mb-3">${date}</div>
          <div class="space-y-2">
            ${groups[date].map(e => `
              <div class="flex items-center justify-between gap-3">
                <div class="min-w-0">
                  <div class="font-extrabold truncate">${e.name}</div>
                  <div class="text-xs text-slate-500 truncate">${e.location || 'غير محدد'}</div>
                </div>
                ${getCountdownBadge(e)}
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      const label = document.getElementById('currentMonthLabel');
      if (!label) return;

      const month = viewDate.getMonth();
      const year = viewDate.getFullYear();
      label.innerText = `${new Intl.DateTimeFormat('ar-SA', { month: 'long' }).format(viewDate)} ${year}`;

      renderCalendarAgenda(month, year);

      if (!grid) return;
      grid.innerHTML = '';

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += `<div class="h-28 bg-gray-50/50 border border-blue-50/20"></div>`;
      }

      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayEvents = events.filter(e => e.start === dateStr);

        const isToday = dateStr === todayStr;

        grid.innerHTML += `
          <div class="h-28 border border-blue-50 p-2 ${isToday ? 'today-cell' : ''}">
            <div class="flex items-center justify-between">
              <span class="text-xs font-black ${isToday ? 'today-pill' : 'text-slate-300'}">${d}</span>
              ${isToday ? `<span class="today-pill">اليوم</span>` : ``}
            </div>

            ${dayEvents.map(e => `
              <div class="event-chip truncate ${getStatusClassByState(e)}" title="${e.name}">
                ${e.name}
              </div>
            `).join('')}
          </div>
        `;
      }

    }

    function renderDirectory() {
      const grids = {
        supervisory: document.getElementById('supervisoryGrid'),
        supporting: document.getElementById('supportingGrid'),
        partners: document.getElementById('partnersGrid')
      };
      Object.values(grids).forEach(g => { if (g) g.innerHTML = ''; });

      entities.forEach(ent => {
        const html = `
          <div class="entity-link p-4 rounded-3xl bg-white shadow-lg flex items-center justify-between font-extrabold gap-3 hover:scale-[1.01] transition-all duration-200">
            <a href="${ent.url}" target="_blank" class="text-slate-800 hover:text-blue-700 flex-grow min-w-0 truncate">${ent.name}</a>
            <div class="flex gap-2 shrink-0">
              <button onclick="editEntity('${ent.id}')" class="text-blue-600" title="تعديل"><i class="fa-solid fa-pen icon-18"></i></button>
              <button onclick="deleteEntity('${ent.id}')" class="text-red-500" title="حذف"><i class="fa-solid fa-trash icon-18"></i></button>
            </div>
          </div>
        `;
        if (grids[ent.category]) grids[ent.category].innerHTML += html;
      });

      const waGrid = document.getElementById('whatsappGrid');
      if (!waGrid) return;

      waGrid.innerHTML = whatsappGroups.map(wa => `
        <div class="flex flex-col items-center p-6 rounded-3xl bg-white border-2 border-green-50 shadow-lg relative hover:scale-[1.01] transition-all duration-200">
          <div class="absolute top-3 left-3 flex gap-2">
            <button onclick="openWhatsappModal('${wa.id}')" class="text-blue-500" title="تعديل"><i class="fa-solid fa-pen icon-18"></i></button>
            <button onclick="deleteWhatsappGroup('${wa.id}')" class="text-red-500" title="حذف"><i class="fa-solid fa-trash icon-18"></i></button>
          </div>
          <a href="${wa.url}" target="_blank" class="flex flex-col items-center gap-2">
            <div class="w-11 h-11 bg-green-100 rounded-full flex items-center justify-center">
              <i class="fa-solid fa-users icon-18 text-green-700"></i>
            </div>
            <span class="font-black text-slate-800 text-sm text-center">${wa.name}</span>
            <span class="text-xs text-green-700 font-bold underline" dir="ltr">Open</span>
          </a>
        </div>
      `).join('');
    }

    const arcValueLabelsPlugin = {
      id: 'arcPercentLabels',
      afterDatasetsDraw(chart) {
        const { ctx } = chart;
        const meta = chart.getDatasetMeta(0);
        const dataset = chart.data.datasets[0];
        if (!meta || !dataset) return;

        const total = dataset.data.reduce((s, v) => s + v, 0) || 1;

        ctx.save();
        ctx.font = '900 12px "Noto Sans Arabic", sans-serif';
        ctx.fillStyle = '#0f172a';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        meta.data.forEach((arc, i) => {
          const value = dataset.data[i];
          if (!value) return;

          const angle = arc.endAngle - arc.startAngle;
          if (angle < 0.28) return;

          const percent = Math.round((value / total) * 100);
          const p = arc.getCenterPoint();
          ctx.fillText(`${percent}%`, p.x, p.y);
        });

        ctx.restore();
      }
    };

    function renderAnalytics() {
      // ---- Donut: events by location ----
      const counts = new Map();
      events.forEach(e => {
        const key = getCityLabel(e);
        counts.set(key, (counts.get(key) || 0) + 1);
      });

      const labels = Array.from(counts.keys());
      const data = Array.from(counts.values());

      const palette = [
        '#ef6a7a', '#4f8fdc', '#6cc7c0', '#f2c14e', '#f59e0b',
        '#a78bfa', '#22c55e', '#94a3b8', '#fb7185', '#60a5fa'
      ];
      const colors = labels.map((_, i) => palette[i % palette.length]);

      const donutCanvas = document.getElementById('citiesDonut');
      if (donutCanvas && typeof Chart !== 'undefined') {
        if (citiesDonutChart) { citiesDonutChart.destroy(); citiesDonutChart = null; }

        citiesDonutChart = new Chart(donutCanvas, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data,
              backgroundColor: colors,
              borderColor: '#ffffff',
              borderWidth: 2,
              hoverOffset: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '62%',
            plugins: {
              legend: { display: false },
              tooltip: { rtl: true }
            }
          },
          plugins: [arcValueLabelsPlugin]
        });
      }

      // Legend list
      const legendEl = document.getElementById('citiesLegend');
      if (legendEl) {
        if (!labels.length) {
          legendEl.innerHTML = `<div class="text-sm font-bold text-slate-500">لا يوجد بيانات</div>`;
        } else {
          legendEl.className = 'pie-legend';
          const total = data.reduce((s, v) => s + v, 0) || 1;

          legendEl.innerHTML = labels.map((lab, i) => {
            const percent = Math.round((data[i] / total) * 100);
            return `
              <div class="legend-item">
                <div class="legend-left">
                  <span class="legend-dot" style="background:${colors[i]}"></span>
                  <span class="legend-label">${lab}</span>
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // ---- Bar: events per month (from start YYYY-MM-DD) ----
      const monthly = new Map(); // YYYY-MM -> count
      events.forEach(e => {
        const s = (e.start || '').trim();
        if (!s || s.length < 7) return;
        const key = s.slice(0, 7);
        monthly.set(key, (monthly.get(key) || 0) + 1);
      });

      const monthLabels = Array.from(monthly.keys()).sort();
      const monthValues = monthLabels.map(k => monthly.get(k));

      const barCanvas = document.getElementById('eventsPerMonthBar');
      if (barCanvas && typeof Chart !== 'undefined') {
        if (eventsPerMonthChart) { eventsPerMonthChart.destroy(); eventsPerMonthChart = null; }

        eventsPerMonthChart = new Chart(barCanvas, {
          type: 'bar',
          data: {
            labels: monthLabels,
            datasets: [{
              label: 'عدد الأحداث',
              data: monthValues,
              borderRadius: 10
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { rtl: true }
            },
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0 } }
            }
          }
        });
      }
    }
    
    function render() {
      updateSortIndicators();
      updateDashboard();
      renderTable();
      renderCards();
      renderCalendar();
      renderDirectory();
      renderAnalytics();
      applySearchFilter();
    }

    function switchView(view) {
      currentView = view;

      document.getElementById('analyticsView').classList.toggle('hidden', view !== 'analytics');
      document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
      document.getElementById('calendarView').classList.toggle('hidden', view !== 'calendar');
      document.getElementById('directoryView').classList.toggle('hidden', view !== 'directory');

      document.getElementById('calendarControls').classList.toggle('hidden', view !== 'calendar');
      document.getElementById('calendarControls').classList.toggle('flex', view === 'calendar');

      document.getElementById('directoryControls').classList.toggle('hidden', view !== 'directory');
      document.getElementById('tableSortControls').classList.toggle('hidden', view !== 'table');

      document.querySelectorAll('#tabsContainer button').forEach(btn => btn.classList.remove('tab-active'));
      document.getElementById(`${view}Btn`).classList.add('tab-active');

      render();
    }

    function changeMonth(dir) {
      viewDate.setMonth(viewDate.getMonth() + dir);
      renderCalendar();
    }

    function applySearchFilter() {
      const term = (document.getElementById('searchInput')?.value || '').toLowerCase().trim();

      document.querySelectorAll('.event-row').forEach(r => {
        const name = r.getAttribute('data-name') || '';
        const owner = r.getAttribute('data-owner') || '';
        r.style.display = (!term || name.includes(term) || owner.includes(term)) ? '' : 'none';
      });

      document.querySelectorAll('.event-card').forEach(c => {
        const name = c.getAttribute('data-name') || '';
        const owner = c.getAttribute('data-owner') || '';
        c.style.display = (!term || name.includes(term) || owner.includes(term)) ? '' : 'none';
      });
    }

    document.getElementById('searchInput').addEventListener('input', applySearchFilter);

    function bindSortableHeaders() {
      document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => setSort(th.getAttribute('data-key')));
      });
    }

    document.getElementById('mobileSortSelect').addEventListener('change', (e) => {
      const [key, dir] = e.target.value.split(':');
      sortState = { key, dir };
      updateSortIndicators();
      renderTable();
      renderCards();
      applySearchFilter();
    });

    // -------------------- Supabase Mutations --------------------
    async function updateStatus(id, newStatus) {
      events = events.map(e => (String(e.id) === String(id) ? { ...e, status: newStatus } : e));
      renderTable(); renderCards(); renderCalendar(); updateDashboard();

      const { error } = await supabaseClient.from('events').update({ status: newStatus }).eq('id', id);
      if (error) {
        console.error('Update Status Error:', error);
        await loadData();
      }
    }

    async function upsertEvent(data) {
      const isNew = !data.id;
      const payload = {
        name: data.name,
        priority: data.priority,
        owner: data.owner,
        assignee1: data.assignee1,
        assignee2: data.assignee2,
        location: data.location,
        start_date: data.start,
        end_date: data.end,
        status: data.status,
        link: data.link
      };
      if (!isNew) payload.id = data.id;

      const { error } = await supabaseClient.from('events').upsert(payload);
      if (error) throw error;

      await loadData();
    }

    async function removeEvent(id) {
      const { error } = await supabaseClient.from('events').delete().eq('id', id);
      if (error) throw error;
      await loadData();
    }

    async function upsertEntity(data) {
      const isNew = !data.id;
      const payload = { name: data.name, url: data.url, category: data.category };
      if (!isNew) payload.id = data.id;

      const { error } = await supabaseClient.from('entities').upsert(payload);
      if (error) throw error;

      await loadData();
    }

    async function removeEntity(id) {
      const { error } = await supabaseClient.from('entities').delete().eq('id', id);
      if (error) throw error;
      await loadData();
    }

    async function upsertWhatsapp(data) {
      const isNew = !data.id;
      const payload = { name: data.name, url: data.url };
      if (!isNew) payload.id = data.id;

      const { error } = await supabaseClient.from('whatsapp_groups').upsert(payload);
      if (error) throw error;

      await loadData();
    }

    async function removeWhatsapp(id) {
      const { error } = await supabaseClient.from('whatsapp_groups').delete().eq('id', id);
      if (error) throw error;
      await loadData();
    }

    // -------------------- Modal helpers --------------------
    let lastFocusEl = null;

    function showModal(modalId, focusId) {
      lastFocusEl = document.activeElement;
      const m = document.getElementById(modalId);
      m.classList.add('modal-active');
      setTimeout(() => document.getElementById(focusId)?.focus(), 0);
    }

    function hideModal(modalId) {
      const m = document.getElementById(modalId);
      m.classList.remove('modal-active');
      if (lastFocusEl && typeof lastFocusEl.focus === 'function') {
        setTimeout(() => lastFocusEl.focus(), 0);
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal(); closeEntityModal(); closeWhatsappModal();
      }
    });

    ['eventModal','entityModal','whatsappModal'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('click', (e) => {
        if (e.target === el) {
          if (id === 'eventModal') closeModal();
          if (id === 'entityModal') closeEntityModal();
          if (id === 'whatsappModal') closeWhatsappModal();
        }
      });
    });

    function openModal(id = null) {
      const f = document.getElementById('eventForm');
      f.reset();

      document.getElementById('eventId').value = id || '';
      document.getElementById('modalTitle').innerText = id ? 'تعديل الحدث' : 'إضافة حدث جديد';

      if (id) {
        const ev = events.find(e => String(e.id) === String(id));
        if (ev) {
          document.getElementById('fName').value = ev.name || '';
          document.getElementById('fPriority').value = ev.priority || 'متوسط الأولوية';
          document.getElementById('fOwner').value = ev.owner || '';
          document.getElementById('fAssignee1').value = ev.assignee1 || '';
          document.getElementById('fAssignee2').value = ev.assignee2 || '';
          document.getElementById('fStart').value = ev.start || '';
          document.getElementById('fEnd').value = ev.end || ev.start || '';
          document.getElementById('fLoc').value = ev.location || '';
          document.getElementById('fLink').value = ev.link || '';
        }
      }

      showModal('eventModal', 'fName');
    }

    function closeModal() { hideModal('eventModal'); }

    document.getElementById('eventForm').onsubmit = async (e) => {
      e.preventDefault();

      const id = document.getElementById('eventId').value;
      const a1 = document.getElementById('fAssignee1').value.trim();
      const a2 = document.getElementById('fAssignee2').value.trim();
      const old = id ? events.find(ev => String(ev.id) === String(id)) : null;

      const data = {
        id: id || undefined,
        name: document.getElementById('fName').value,
        priority: document.getElementById('fPriority').value,
        owner: document.getElementById('fOwner').value,
        assignee1: a1,
        assignee2: a2,
        location: document.getElementById('fLoc').value,
        start: document.getElementById('fStart').value,
        end: document.getElementById('fEnd').value,
        link: document.getElementById('fLink').value,
        status: old?.status || 'لم تبدأ'
      };

      try { await upsertEvent(data); closeModal(); }
      catch (err) { console.error('Save Event Error:', err); alert('حدث خطأ أثناء حفظ الحدث. راجع Console للتفاصيل.'); }
    };

    function editEvent(id) { openModal(id); }

    async function deleteEvent(id) {
      if (!confirm('حذف الحدث؟')) return;
      try { await removeEvent(id); }
      catch (err) { console.error('Delete Event Error:', err); alert('حدث خطأ أثناء حذف الحدث.'); }
    }

    function openEntityModal(id = null) {
      document.getElementById('entId').value = id || '';

      if (id) {
        const ent = entities.find(x => String(x.id) === String(id));
        document.getElementById('entName').value = ent?.name || '';
        document.getElementById('entUrl').value = ent?.url || '';
        document.getElementById('entCat').value = ent?.category || 'supervisory';
        document.getElementById('entityModalTitle').innerText = 'تعديل الجهة';
      } else {
        document.getElementById('entName').value = '';
        document.getElementById('entUrl').value = '';
        document.getElementById('entCat').value = 'supervisory';
        document.getElementById('entityModalTitle').innerText = 'إضافة جهة جديدة';
      }

      showModal('entityModal', 'entName');
    }

    function closeEntityModal() { hideModal('entityModal'); }

    document.getElementById('entityForm').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('entId').value;

      const data = {
        id: id || undefined,
        name: document.getElementById('entName').value,
        url: document.getElementById('entUrl').value,
        category: document.getElementById('entCat').value
      };

      try { await upsertEntity(data); closeEntityModal(); }
      catch (err) { console.error('Save Entity Error:', err); alert('حدث خطأ أثناء حفظ الجهة.'); }
    };

    function editEntity(id) { openEntityModal(id); }

    async function deleteEntity(id) {
      if (!confirm('حذف الجهة؟')) return;
      try { await removeEntity(id); }
      catch (err) { console.error('Delete Entity Error:', err); alert('حدث خطأ أثناء حذف الجهة.'); }
    }

    function openWhatsappModal(id = null) {
      document.getElementById('waId').value = id || '';

      if (id) {
        const wa = whatsappGroups.find(w => String(w.id) === String(id));
        document.getElementById('waName').value = wa?.name || '';
        document.getElementById('waUrl').value = wa?.url || '';
        document.getElementById('waModalTitle').innerText = 'تعديل المجموعة';
      } else {
        document.getElementById('waName').value = '';
        document.getElementById('waUrl').value = '';
        document.getElementById('waModalTitle').innerText = 'إضافة مجموعة';
      }

      showModal('whatsappModal', 'waName');
    }

    function closeWhatsappModal() { hideModal('whatsappModal'); }

    document.getElementById('waForm').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('waId').value;

      const data = {
        id: id || undefined,
        name: document.getElementById('waName').value,
        url: document.getElementById('waUrl').value
      };

      try { await upsertWhatsapp(data); closeWhatsappModal(); }
      catch (err) { console.error('Save WhatsApp Error:', err); alert('حدث خطأ أثناء حفظ المجموعة.'); }
    };

    async function deleteWhatsappGroup(id) {
      if (!confirm('حذف مجموعة الواتساب؟')) return;
      try { await removeWhatsapp(id); }
      catch (err) { console.error('Delete WhatsApp Error:', err); alert('حدث خطأ أثناء حذف مجموعة الواتساب.'); }
    }
    
    // Init
    window.onload = async () => {
      await loadData();
      switchView('analytics');
      bindSortableHeaders();
      updateSortIndicators();
      document.getElementById('mobileSortSelect').value = `${sortState.key}:${sortState.dir}`;
    };
  </script>
</body>
</html>